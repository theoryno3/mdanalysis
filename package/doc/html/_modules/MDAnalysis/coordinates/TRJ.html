

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MDAnalysis.coordinates.TRJ &mdash; MDAnalysis 0.10.0-dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.10.0-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within MDAnalysis 0.10.0-dev documentation"
          href="../../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../../_static/mdanalysis-logo.ico"/>
    <link rel="top" title="MDAnalysis 0.10.0-dev documentation" href="../../../index.html" />
    <link rel="up" title="MDAnalysis" href="../../MDAnalysis.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">MDAnalysis 0.10.0-dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../MDAnalysis.html" accesskey="U">MDAnalysis</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/mdanalysis-logo-200x150.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for MDAnalysis.coordinates.TRJ</h1><div class="highlight"><pre>
<span class="c"># -*- Mode: python; tab-width: 4; indent-tabs-mode:nil; coding:utf-8 -*-</span>
<span class="c"># vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4 fileencoding=utf-8</span>
<span class="c">#</span>
<span class="c"># MDAnalysis --- http://www.MDAnalysis.org</span>
<span class="c"># Copyright (c) 2006-2015 Naveen Michaud-Agrawal, Elizabeth J. Denning, Oliver Beckstein</span>
<span class="c"># and contributors (see AUTHORS for the full list)</span>
<span class="c">#</span>
<span class="c"># Released under the GNU Public Licence, v2 or any higher version</span>
<span class="c">#</span>
<span class="c"># Please cite your use of MDAnalysis in published work:</span>
<span class="c">#</span>
<span class="c"># N. Michaud-Agrawal, E. J. Denning, T. B. Woolf, and O. Beckstein.</span>
<span class="c"># MDAnalysis: A Toolkit for the Analysis of Molecular Dynamics Simulations.</span>
<span class="c"># J. Comput. Chem. 32 (2011), 2319--2327, doi:10.1002/jcc.21787</span>
<span class="c">#</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">AMBER trajectories --- :mod:`MDAnalysis.coordinates.TRJ`</span>
<span class="sd">========================================================</span>

<span class="sd">AMBER_ can write :ref:`ASCII trajectories&lt;ascii-trajectories&gt;` (&quot;traj&quot;) and</span>
<span class="sd">:ref:`binary trajectories&lt;netcdf-trajectories&gt;` (&quot;netcdf&quot;). MDAnalysis supports</span>
<span class="sd">reading of both formats and writing for the binary trajectories.</span>

<span class="sd">.. Note::</span>

<span class="sd">   Support for AMBER is *experimental* and feedback and contributions</span>
<span class="sd">   are highly appreciated. Use the `Issue Tracker`_ or get in touch on</span>
<span class="sd">   the `MDAnalysis mailinglist`_.</span>

<span class="sd">.. rubric:: Units</span>

<span class="sd">* lengths in Angstrom (Å)</span>
<span class="sd">* time in ps (but see below)</span>

<span class="sd">AMBER trajectory coordinate frames are based on a :class:`Timestep`</span>
<span class="sd">object.</span>

<span class="sd">.. autoclass:: Timestep</span>
<span class="sd">   :members:</span>

<span class="sd">   .. attribute:: _pos</span>

<span class="sd">      coordinates of the atoms as a :class:`numpy.ndarray` of shape `(numatoms, 3)`</span>

<span class="sd">   .. attribute:: _velocities</span>

<span class="sd">      velocities of the atoms as a :class:`numpy.ndarray` of shape `(numatoms, 3)`;</span>
<span class="sd">      only available if the trajectory contains velocities or if the</span>
<span class="sd">      *velocities* = ``True`` keyword has been supplied.</span>

<span class="sd">   .. attribute:: _forces</span>

<span class="sd">      forces of the atoms as a :class:`numpy.ndarray` of shape `(numatoms, 3)`;</span>
<span class="sd">      only available if the trajectory contains forces or if the</span>
<span class="sd">      *forces* = ``True`` keyword has been supplied.</span>


<span class="sd">.. _ascii-trajectories:</span>

<span class="sd">ASCII TRAJ trajectories</span>
<span class="sd">-----------------------</span>

<span class="sd">ASCII AMBER_ TRJ coordinate files (as defined in `AMBER TRJ format`_)</span>
<span class="sd">are handled by the :class:`TRJReader`. It is also possible to directly</span>
<span class="sd">read *bzip2* or *gzip* compressed files.</span>

<span class="sd">AMBER ASCII trajectories are recognised by the suffix &#39;.trj&#39; or</span>
<span class="sd">&#39;.mdcrd&#39; (possibly with an additional &#39;.gz&#39; or &#39;.bz2&#39;).</span>

<span class="sd">.. rubric:: Limitations</span>

<span class="sd">* Periodic boxes are only stored as box lengths A, B, C in an AMBER</span>
<span class="sd">  trajectory; the reader always assumes that these are orthorhombic</span>
<span class="sd">  boxes.</span>

<span class="sd">* The trajectory does not contain time information so we simply set</span>
<span class="sd">  the time step to 1 ps (or the user could provide it as kwarg *delta*)</span>

<span class="sd">* No direct access of frames is implemented, only iteration through</span>
<span class="sd">  the trajectory.</span>

<span class="sd">* Trajectories with fewer than 4 atoms probably fail to be read (BUG).</span>

<span class="sd">* If the trajectory contains exactly *one* atom then it is always</span>
<span class="sd">  assumed to be non-periodic (for technical reasons).</span>


<span class="sd">.. autoclass:: TRJReader</span>
<span class="sd">   :members:</span>


<span class="sd">.. _netcdf-trajectories:</span>

<span class="sd">Binary NetCDF trajectories</span>
<span class="sd">--------------------------</span>

<span class="sd">The `AMBER netcdf`_ format make use of NetCDF_ (Network Common Data</span>
<span class="sd">Form) format. Such binary trajectories are recognized in MDAnalysis by</span>
<span class="sd">the &#39;.ncdf&#39; suffix and read by the :class:`NCDFReader`.</span>

<span class="sd">Binary trajectories can also contain velocities and forces, and can record the</span>
<span class="sd">exact time</span>
<span class="sd">step. In principle, the trajectories can be in different units than the AMBER</span>
<span class="sd">defaults of ångström and picoseconds but at the moment MDAnalysis only supports</span>
<span class="sd">those and will raise a :exc:`NotImplementedError` if anything else is detected.</span>

<span class="sd">.. autoclass:: NCDFReader</span>
<span class="sd">   :members:</span>

<span class="sd">   .. automethod:: __getitem__</span>
<span class="sd">   .. automethod:: __iter__</span>

<span class="sd">.. autoclass:: NCDFWriter</span>
<span class="sd">   :members:</span>


<span class="sd">.. Links</span>

<span class="sd">.. _AMBER: http://ambermd.org</span>
<span class="sd">.. _AMBER TRJ format: http://ambermd.org/formats.html#trajectory</span>
<span class="sd">.. _AMBER netcdf format: http://ambermd.org/netcdf/nctraj.html</span>
<span class="sd">.. _AMBER netcdf: http://ambermd.org/netcdf/nctraj.html</span>
<span class="sd">.. _NetCDF: http://www.unidata.ucar.edu/software/netcdf</span>
<span class="sd">.. _Issue Tracker: https://github.com/MDAnalysis/mdanalysis/issues</span>
<span class="sd">.. _MDAnalysis mailinglist: http://groups.google.com/group/mdnalysis-discussion</span>



<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">MDAnalysis</span>
<span class="kn">from</span> <span class="nn">..core</span> <span class="kn">import</span> <span class="n">flags</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">import</span> <span class="nn">MDAnalysis.core.util</span> <span class="kn">as</span> <span class="nn">util</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;MDAnalysis.coordinates.AMBER&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">netCDF4</span> <span class="kn">as</span> <span class="nn">netcdf</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c"># Just to notify the user; the module will still load. However, NCDFReader and NCDFWriter</span>
    <span class="c"># will raise a proper ImportError if they are called without the netCDF4 library present.</span>
    <span class="c"># See Issue 122 for a discussion.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Failed to import netCDF4; AMBER NETCDFReader/Writer will not work. &quot;</span>
                 <span class="s">&quot;Install netCDF4 from https://github.com/Unidata/netcdf4-python.&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;See also https://github.com/MDAnalysis/mdanalysis/wiki/netcdf&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Timestep"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.Timestep">[docs]</a><span class="k">class</span> <span class="nc">Timestep</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Timestep</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AMBER trajectory Timestep.</span>

<span class="sd">    The Timestep can be initialized with *arg* being</span>

<span class="sd">    1. an integer (the number of atoms) and an optional keyword argument *velocities* to allocate</span>
<span class="sd">       space for both coordinates and velocities;</span>
<span class="sd">    2. another :class:`Timestep` instance, in which case a copy is made (If the copied Timestep</span>
<span class="sd">       does not contain velocities but *velocities* = ``True`` is provided, then space for</span>
<span class="sd">       velocities is allocated);</span>
<span class="sd">    3. a :class:`numpy.ndarray` of shape ``(numatoms, 3)`` (for positions only) or</span>
<span class="sd">       ``(numatoms, 6)`` (for positions and velocities): ``positions = arg[:,:3]``,</span>
<span class="sd">       ``velocities = arg[:,3:6]``.</span>


<span class="sd">    .. versionchanged:: 0.10.0</span>
<span class="sd">       Added ability to contain Forces</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># based on TRR Timestep (MDAnalysis.coordinates.xdrfile.TRR.Timestep)</span>
    <span class="c">#</span>
    <span class="c"># NOTE: kwargs is a new thing for Timesteps and not yet in the</span>
    <span class="c"># trajectory API; if this breaks something then we should simply make</span>
    <span class="c"># two different classes, one with the other without velocities. [orbeckst, 2012-05-29]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;velocities&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;forces&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">DIM</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="c"># C floats and C-order for arrays</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">,</span> <span class="n">DIM</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">velocities</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_velocities</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">,</span> <span class="n">DIM</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">forces</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_forces</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">,</span> <span class="n">DIM</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">DIM</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c"># A,B,C,alpha,beta,gamma</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Timestep</span><span class="p">):</span>  <span class="c"># Copy constructor</span>
            <span class="c"># This makes a deepcopy of the timestep</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">frame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">numatoms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_velocities</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_velocities</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_forces</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_forces</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;step&#39;</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c"># provide packed array shape == (natoms, 2*DIM)</span>
            <span class="c"># which contains pos = arg[:,0:3], v = arg[:,3:6]</span>
            <span class="c"># or just positions: pos = arg[:,0:3] == arg</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;packed numpy array (x,v) can only have 2 dimensions&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">DIM</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">DIM</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">DIM</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">DIM</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DIM</span><span class="p">):</span>
                <span class="c"># wrong order (but need to exclude case where natoms == DIM or natoms == 2*DIM!)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;AMBER timestep is to be initialized from (natoms, 2*3) or (natoms, 3) array&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">DIM</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">)</span>  <span class="c"># C-order</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">DIM</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_velocities</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[:,</span> <span class="n">DIM</span><span class="p">:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">DIM</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">)</span>  <span class="c"># C-order</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">DIM</span> <span class="ow">and</span> <span class="n">velocities</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_velocities</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">DIM</span><span class="p">:</span>
                <span class="c"># only positions</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;AMBER timestep has no second dimension 3 or 6: shape=</span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot create an empty Timestep&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;unitcell dimensions (`A, B, C, alpha, beta, gamma`)</span>

<span class="sd">        - `A, B, C` are the lengths of the primitive cell vectors `e1, e2, e3`</span>
<span class="sd">        - `alpha` = angle(`e1, e2`)</span>
<span class="sd">        - `beta` = angle(`e1, e3`)</span>
<span class="sd">        - `gamma` = angle(`e2, e3`)</span>

<span class="sd">        .. Note::</span>

<span class="sd">           A :ref:`ASCII AMBER trajectory&lt;ascii-trajectories&gt;` only contains box lengths</span>
<span class="sd">           `A,B,C`; we assume an orthorhombic box and set all</span>
<span class="sd">           angles to 90º.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Layout of unitcell is [A,B,C,90,90,90] with the primitive cell vectors</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span>

    <span class="nd">@dimensions.setter</span>
<div class="viewcode-block" id="Timestep.dimensions"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.Timestep.dimensions">[docs]</a>    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span> <span class="o">=</span> <span class="n">box</span>

</div></div>
<div class="viewcode-block" id="TRJReader"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.TRJReader">[docs]</a><span class="k">class</span> <span class="nc">TRJReader</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;AMBER trajectory reader.</span>

<span class="sd">    Reads the ASCII formatted `AMBER TRJ format`_. Periodic box information</span>
<span class="sd">    is auto-detected.</span>

<span class="sd">    The number of atoms in a timestep *must* be provided in the `numatoms`</span>
<span class="sd">    keyword because it is not stored in the trajectory header and cannot be</span>
<span class="sd">    reliably autodetected. The constructor raises a :exc:`ValueError` if</span>
<span class="sd">    `numatoms` is left at its default value of ``None``.</span>

<span class="sd">    The length of a timestep is not stored in the trajectory itself but can</span>
<span class="sd">    be set by passing the `delta` keyword argument to the constructor; it</span>
<span class="sd">    is assumed to be in ps. The default value is 1 ps.</span>

<span class="sd">    Functionality is currently limited to simple iteration over the</span>
<span class="sd">    trajectory.</span>

<span class="sd">    .. _AMBER TRJ format: http://ambermd.org/formats.html#trajectory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;TRJ&#39;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;ps&#39;</span><span class="p">,</span> <span class="s">&#39;length&#39;</span><span class="p">:</span> <span class="s">&#39;Angstrom&#39;</span><span class="p">}</span>
    <span class="n">_Timestep</span> <span class="o">=</span> <span class="n">Timestep</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">numatoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># amber trj REQUIRES the number of atoms from the topology</span>
        <span class="k">if</span> <span class="n">numatoms</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;AMBER TRJ reader REQUIRES the numatoms keyword&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numatoms</span> <span class="o">=</span> <span class="n">numatoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numframes</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># have _read_next_timestep() open it properly!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_timestep</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># always 1 for trj at the moment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;delta&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c"># can set delta manually, default is 1ps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Timestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">)</span>

        <span class="c"># FORMAT(10F8.3)  (X(i), Y(i), Z(i), i=1,NATOM)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_line_parser</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">FORTRANReader</span><span class="p">(</span><span class="s">&quot;10F8.3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines_per_frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_line_parser</span><span class="p">)))</span>
        <span class="c"># The last line per frame might have fewer than 10</span>
        <span class="c"># We determine right away what parser we need for the last</span>
        <span class="c"># line because it will be the same for all frames.</span>
        <span class="n">last_per_line</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_line_parser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_line_parser</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">FORTRANReader</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">F8.3&quot;</span> <span class="o">%</span> <span class="n">last_per_line</span><span class="p">)</span>

        <span class="c"># FORMAT(10F8.3)  BOX(1), BOX(2), BOX(3)</span>
        <span class="c"># is this always on a separate line??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_line_parser</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">FORTRANReader</span><span class="p">(</span><span class="s">&quot;3F8.3&quot;</span><span class="p">)</span>

        <span class="c"># Now check for box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detect_amber_box</span><span class="p">()</span>

        <span class="c"># open file, read first frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># FORMAT(10F8.3)  (X(i), Y(i), Z(i), i=1,NATOM)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_trajectory</span><span class="p">()</span>

        <span class="c"># Read coordinat frame:</span>
        <span class="c">#coordinates = numpy.zeros(3*self.numatoms, dtype=numpy.float32)</span>
        <span class="n">_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_coords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_line_parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c"># less than 10 entries on the line:</span>
                <span class="n">_coords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_line_parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_per_frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># read all atoms that are there in this frame</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">_coords</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="c"># at the end of the stream (the loop has not been entered)</span>
            <span class="k">raise</span> <span class="ne">EOFError</span>

        <span class="c"># Read box information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_line_parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">]</span>  <span class="c"># assumed</span>

        <span class="c"># probably slow ... could be optimized by storing the coordinates in X,Y,Z</span>
        <span class="c"># lists or directly filling the array; the array/reshape is not good</span>
        <span class="c"># because it creates an intermediate array</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_coords</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">def</span> <span class="nf">_detect_amber_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detecting a box in a AMBER trajectory</span>

<span class="sd">        Rewind trajectory and check for potential box data</span>
<span class="sd">        after the first frame.</span>

<span class="sd">        Set :attr:`TRJReader.periodic` to ``True`` if box was</span>
<span class="sd">        found, ``False`` otherwise.</span>

<span class="sd">        Only run at the beginning as it *rewinds* the trajctory.</span>

<span class="sd">         - see if there&#39;s data after the atoms have been read that looks</span>
<span class="sd">           like::</span>

<span class="sd">             FORMAT(10F8.3)  BOX(1), BOX(2), BOX(3)</span>
<span class="sd">             BOX    : size of periodic box</span>

<span class="sd">         - this WILL fail if we have exactly 1 atom in the trajectory because</span>
<span class="sd">           there&#39;s no way to distinguish the coordinates from the box</span>
<span class="sd">           so for 1 atom we always assume no box</span>
<span class="sd">         XXX: needs a Timestep that knows about AMBER unitcells!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># for 1 atom we cannot detect the box with the current approach</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># see _read_next_timestep()!</span>
            <span class="n">wmsg</span> <span class="o">=</span> <span class="s">&quot;Trajectory contains a single atom: assuming periodic=False&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">wmsg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reopen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># make sure that only coordinates are read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="c"># TODO: what do we do with 1-frame trajectories? Try..except EOFError?</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">nentries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_line_parser</span><span class="o">.</span><span class="n">number_of_matches</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nentries</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_line_parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">]</span>  <span class="c"># assumed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TRJReader.numframes"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.TRJReader.numframes">[docs]</a>    <span class="k">def</span> <span class="nf">numframes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of frames (obtained from reading the whole trajectory).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numframes</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># return cached value</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numframes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_numframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_trj_numframes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numframes</span>
</div>
    <span class="k">def</span> <span class="nf">_read_trj_numframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reopen</span><span class="p">()</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">counter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">numatoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numatoms</span>

    <span class="k">def</span> <span class="nf">_reopen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trajectory</span><span class="p">()</span>

<div class="viewcode-block" id="TRJReader.open_trajectory"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.TRJReader.open_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">open_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the trajectory for reading and load first frame.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">anyopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c"># ignore first line</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
            <span class="c"># Chimera uses this check</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s">&quot;Header of AMBER formatted trajectory has more than 80 chars. &quot;</span>
                          <span class="s">&quot;This is probably not a AMBER trajectory.&quot;</span><span class="p">)</span>
        <span class="c"># reset ts</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span>
</div>
<div class="viewcode-block" id="TRJReader.close"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.TRJReader.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close trj trajectory file if it was open.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="TRJReader.rewind"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.TRJReader.rewind">[docs]</a>    <span class="k">def</span> <span class="nf">rewind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reposition at the beginning of the trajectory&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reopen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reopen</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>

</div>
<div class="viewcode-block" id="NCDFReader"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.NCDFReader">[docs]</a><span class="k">class</span> <span class="nc">NCDFReader</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reader for `AMBER NETCDF format`_ (version 1.0).</span>

<span class="sd">    AMBER binary trajectories are automatically recognised by the</span>
<span class="sd">    file extension &quot;.ncdf&quot;.</span>

<span class="sd">    The number of atoms (*numatoms*) does not have to be provided as it can</span>
<span class="sd">    be read from the trajectory. The trajectory reader can randomly access</span>
<span class="sd">    frames and therefore supports direct indexing (with 0-based frame</span>
<span class="sd">    indices) and full-feature trajectory iteration, including slicing.</span>

<span class="sd">    Velocities are autodetected and read into the</span>
<span class="sd">    :attr:`Timestep._velocities` attribute.</span>

<span class="sd">    Forces are autodetected and read into the</span>
<span class="sd">    :attr:`Timestep._forces` attribute.</span>

<span class="sd">    Periodic unit cell information is detected and used to populate the</span>
<span class="sd">    :attr:`Timestep.dimensions` attribute. (If no unit cell is available in</span>
<span class="sd">    the trajectory, then :attr:`Timestep.dimensions` will return</span>
<span class="sd">    ``[0,0,0,0,0,0]``.)</span>

<span class="sd">    Current limitations:</span>

<span class="sd">    * only trajectories with time in ps and lengths in Angstroem are processed</span>
<span class="sd">    * scale_factors are not supported (and not checked)</span>

<span class="sd">    .. _AMBER NETCDF format: http://ambermd.org/netcdf/nctraj.html</span>

<span class="sd">    .. SeeAlso:: :class:`NCDFWriter`</span>

<span class="sd">    .. versionadded: 0.7.6</span>
<span class="sd">    .. versionchanged:: 0.10.0</span>
<span class="sd">       Added ability to read Forces</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;NCDF&#39;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;ps&#39;</span><span class="p">,</span> <span class="s">&#39;length&#39;</span><span class="p">:</span> <span class="s">&#39;Angstrom&#39;</span><span class="p">,</span> <span class="s">&#39;velocity&#39;</span><span class="p">:</span> <span class="s">&#39;Angstrom/ps&#39;</span><span class="p">,</span>
             <span class="s">&#39;force&#39;</span><span class="p">:</span> <span class="s">&#39;kcal/(mol*Angstrom)&#39;</span><span class="p">}</span>
    <span class="n">_Timestep</span> <span class="o">=</span> <span class="n">Timestep</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">numatoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">netCDF4</span> <span class="kn">as</span> <span class="nn">netcdf</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span>
                <span class="s">&quot;netcdf4-python with the netCDF and HDF5 libraries must be installed for the AMBER ncdf Reader.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s">&quot;See installation instructions at https://github.com/MDAnalysis/mdanalysis/wiki/netcdf&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&quot;netCDF4 package missing.</span><span class="se">\n</span><span class="s">&quot;</span>
                              <span class="s">&quot;netcdf4-python with the netCDF and HDF5 libraries must be installed for the AMBER ncdf &quot;</span>
                              <span class="s">&quot;Reader.</span><span class="se">\n</span><span class="s">&quot;</span>
                              <span class="s">&quot;See installation instructions at https://github.com/MDAnalysis/mdanalysis/wiki/netcdf&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">convert_units</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;convert_units&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">convert_units</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">convert_units</span> <span class="o">=</span> <span class="n">flags</span><span class="p">[</span><span class="s">&#39;convert_lengths&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span> <span class="o">=</span> <span class="n">convert_units</span>  <span class="c"># convert length and time to base units</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="o">=</span> <span class="n">netcdf</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s">&#39;AMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">Conventions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="s">&#39;AMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">Conventions</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;NCDF trajectory {0} does not conform to AMBER specifications, &quot;</span> <span class="o">+</span>
                      <span class="s">&quot;http://ambermd.org/netcdf/nctraj.html (&#39;AMBER&#39; must be one of the tokens &quot;</span> <span class="o">+</span>
                      <span class="s">&quot;in attribute Conventions)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">ConventionVersion</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="n">wmsg</span> <span class="o">=</span> <span class="s">&quot;NCDF trajectory format is </span><span class="si">%s</span><span class="s"> but the reader implements format </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">ConventionVersion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">wmsg</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">wmsg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s">&#39;atom&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numframes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s">&#39;frame&#39;</span><span class="p">])</span>
        <span class="c"># also records time steps in data.variables[&#39;time&#39;] and unit</span>
        <span class="c"># but my example only has 0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remarks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">title</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remarks</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="c"># other metadata (*= requd):</span>
        <span class="c"># - program*              sander</span>
        <span class="c"># - programVersion*       9.0</span>
        <span class="c"># - application           AMBER</span>
        <span class="c">#</span>

        <span class="c"># checks for not-implemented features (other units would need to be hacked into core.units)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="s">&quot;picosecond&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&quot;NETCDFReader currently assumes that the trajectory was written with a time unit of picoseconds and &quot;</span>
                <span class="s">&quot;not {0}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="s">&quot;angstrom&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s">&quot;NETCDFReader currently assumes that the trajectory was written with a length unit of Angstroem and &quot;</span>
                <span class="s">&quot;not {0}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">],</span> <span class="s">&#39;scale_factor&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;scale_factors are not implemented&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numatoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">numatoms</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Supplied numatoms (</span><span class="si">%d</span><span class="s">) != natom from ncdf (</span><span class="si">%d</span><span class="s">). &quot;</span>
                                 <span class="s">&quot;Note: numatoms can be None and then the ncdf value is used!&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                 <span class="n">numatoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span> <span class="o">=</span> <span class="s">&#39;velocities&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span> <span class="o">=</span> <span class="s">&#39;forces&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_timestep</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># always 1 for trj at the moment ? CHECK DOCS??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;delta&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c"># SHOULD GET FROM NCDF (as mean(diff(time)))??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="s">&#39;cell_lengths&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Timestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">,</span> <span class="n">velocities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">,</span>
                                 <span class="n">forces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">)</span>

        <span class="c"># load first data frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_frame</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Trajectory is closed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span> <span class="o">!=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
            <span class="c"># convention... for netcdf could also be a slice</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;frame must be a positive integer&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numframes</span> <span class="ow">or</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&quot;frame index must be 0 &lt;= frame &lt; {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numframes</span><span class="p">))</span>
        <span class="c"># note: self.trjfile.variables[&#39;coordinates&#39;].shape == (frames, numatoms, 3)</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">:</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_velocities</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;velocities&#39;</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">:</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_forces</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;forces&#39;</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;cell_lengths&#39;</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;cell_angles&#39;</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_from_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>  <span class="c"># in-place !</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_time_from_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>  <span class="c"># in-place ! (hope this works...)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">convert_velocities_from_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_velocities</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">convert_forces_from_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_forces</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_from_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>  <span class="c"># in-place ! (only lengths)</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c"># frame labels are 1-based</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">def</span> <span class="nf">_read_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span>

    <span class="k">def</span> <span class="nf">_sliced_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">iterNETCDF</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_frame</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">iterNETCDF</span><span class="p">()</span> 
    
<div class="viewcode-block" id="NCDFReader.__iter__"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.NCDFReader.__iter__">[docs]</a>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over the whole trajectory&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numframes</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_frame</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
</div>
<div class="viewcode-block" id="NCDFReader.close"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.NCDFReader.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close trajectory; any further access will raise an :exc:`IOError`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="NCDFReader.Writer"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.NCDFReader.Writer">[docs]</a>    <span class="k">def</span> <span class="nf">Writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a NCDFWriter for *filename* with the same parameters as this NCDF.</span>

<span class="sd">        All values can be changed through keyword arguments.</span>

<span class="sd">        :Arguments:</span>
<span class="sd">          *filename*</span>
<span class="sd">              filename of the output NCDF trajectory</span>
<span class="sd">        :Keywords:</span>
<span class="sd">          *numatoms*</span>
<span class="sd">              number of atoms</span>
<span class="sd">          *delta*</span>
<span class="sd">              length of one timestep in picoseconds</span>
<span class="sd">          *remarks*</span>
<span class="sd">              string that is stored in the title field</span>

<span class="sd">        :Returns: :class:`NCDFWriter`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">numatoms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;numatoms&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;remarks&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remarks</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;delta&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NCDFWriter</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">numatoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="NCDFWriter"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.NCDFWriter">[docs]</a><span class="k">class</span> <span class="nc">NCDFWriter</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Writer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writer for `AMBER NETCDF format`_ (version 1.0).</span>

<span class="sd">    AMBER binary trajectories are automatically recognised by the</span>
<span class="sd">    file extension &quot;.ncdf&quot;.</span>

<span class="sd">    Velocities are written out if they are detected in the input</span>
<span class="sd">    :class:`Timestep`. The trajectories are always written with ångström</span>
<span class="sd">    for the lengths and picoseconds for the time (and hence Å/ps for</span>
<span class="sd">    velocities).</span>

<span class="sd">    Unit cell information is written if available.</span>

<span class="sd">    .. _AMBER NETCDF format: http://ambermd.org/netcdf/nctraj.html</span>

<span class="sd">    .. SeeAlso:: :class:`NCDFReader`</span>

<span class="sd">    .. versionadded: 0.7.6</span>

<span class="sd">    .. versionchanged:: 0.10.0</span>
<span class="sd">       Added ability to write velocities and forces</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;NCDF&#39;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;ps&#39;</span><span class="p">,</span> <span class="s">&#39;length&#39;</span><span class="p">:</span> <span class="s">&#39;Angstrom&#39;</span><span class="p">,</span> <span class="s">&#39;velocity&#39;</span><span class="p">:</span> <span class="s">&#39;Angstrom/ps&#39;</span><span class="p">,</span>
             <span class="s">&#39;force&#39;</span><span class="p">:</span> <span class="s">&#39;kcal/(mol*Angstrom)&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">numatoms</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">remarks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">convert_units</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zlib</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cmplevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new NCDFWriter</span>

<span class="sd">        :Arguments:</span>
<span class="sd">         *filename*</span>
<span class="sd">            name of output file</span>
<span class="sd">         *numatoms*</span>
<span class="sd">            number of atoms in trajectory file</span>

<span class="sd">        :Keywords:</span>
<span class="sd">          *start*</span>
<span class="sd">            starting timestep</span>
<span class="sd">          *step*</span>
<span class="sd">            skip between subsequent timesteps</span>
<span class="sd">          *delta*</span>
<span class="sd">            timestep</span>
<span class="sd">          *convert_units*</span>
<span class="sd">            ``True``: units are converted to the AMBER base format; ``None`` selects</span>
<span class="sd">            the value of :data:`MDAnalysis.core.flags` [&#39;convert_lengths&#39;].</span>
<span class="sd">            (see :ref:`flags-label`)</span>
<span class="sd">          *zlib*</span>
<span class="sd">            compress data [``False``]</span>
<span class="sd">          *cmplevel*</span>
<span class="sd">            compression level (1-9) [1]</span>
<span class="sd">          *velocities*</span>
<span class="sd">            Write velocities into the trajectory [``False``]</span>
<span class="sd">          *forces*</span>
<span class="sd">            Write forces into the trajectory [``False``]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">numatoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;NCDFWriter: no atoms in output trajectory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">=</span> <span class="n">numatoms</span>
        <span class="k">if</span> <span class="n">convert_units</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">convert_units</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s">&#39;convert_lengths&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span> <span class="o">=</span> <span class="n">convert_units</span>  <span class="c"># convert length and time to base units on the fly?</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>  <span class="c"># do we use those?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>  <span class="c"># do we use those?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remarks</span> <span class="o">=</span> <span class="n">remarks</span> <span class="ow">or</span> <span class="s">&quot;AMBER NetCDF format (MDAnalysis.coordinates.trj.NCDFWriter)&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zlib</span> <span class="o">=</span> <span class="n">zlib</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmplevel</span> <span class="o">=</span> <span class="n">cmplevel</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># when/why would this be assigned??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_frame</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># signals to open trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># open on first write with _init_netcdf()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># detect on first write</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;velocities&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;forces&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_frame</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_init_netcdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize netcdf AMBER 1.0 trajectory.</span>

<span class="sd">        The trajectory is opened when the first frame is written</span>
<span class="sd">        because that is the earlies time that we can detect if the</span>
<span class="sd">        output should contain periodicity information (i.e. the unit</span>
<span class="sd">        cell dimensions).</span>

<span class="sd">        Based on Joshua Adelman&#39;s `netcdf4storage.py`_ in `Issue 109`_.</span>

<span class="sd">        .. _`Issue 109`:</span>
<span class="sd">           https://github.com/MDAnalysis/mdanalysis/issues/109</span>
<span class="sd">        .. _`netcdf4storage.py`:</span>
<span class="sd">           https://storage.googleapis.com/google-code-attachments/mdanalysis/issue-109/comment-2/netcdf4storage.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">netCDF4</span> <span class="kn">as</span> <span class="nn">netcdf</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span>
                <span class="s">&quot;netcdf4-python with the netCDF and HDF5 libraries must be installed for the AMBER ncdf Writer.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s">&quot;See installation instructions at https://github.com/MDAnalysis/mdanalysis/wiki/netcdf&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&quot;netCDF4 package missing.</span><span class="se">\n</span><span class="s">&quot;</span>
                              <span class="s">&quot;netcdf4-python with the netCDF and HDF5 libraries must be installed for the AMBER ncdf &quot;</span>
                              <span class="s">&quot;Writer.</span><span class="se">\n</span><span class="s">&quot;</span>
                              <span class="s">&quot;See installation instructions at https://github.com/MDAnalysis/mdanalysis/wiki/netcdf&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_frame</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&quot;Attempt to write to closed file {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">netcdf</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;NETCDF3_64BIT&#39;</span><span class="p">)</span>

        <span class="c"># Set global attributes.</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s">&#39;program&#39;</span><span class="p">,</span> <span class="s">&#39;MDAnalysis.coordinates.TRJ.NCDFWriter&#39;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s">&#39;programVersion&#39;</span><span class="p">,</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s">&#39;Conventions&#39;</span><span class="p">,</span> <span class="s">&#39;AMBER&#39;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s">&#39;ConventionVersion&#39;</span><span class="p">,</span> <span class="s">&#39;1.0&#39;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ncfile</span><span class="p">,</span> <span class="s">&#39;application&#39;</span><span class="p">,</span> <span class="s">&#39;MDAnalysis&#39;</span><span class="p">)</span>

        <span class="c"># Create dimensions</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s">&#39;frame&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>  <span class="c"># unlimited number of steps (can append)</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s">&#39;atom&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">)</span>  <span class="c"># number of atoms in system</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s">&#39;spatial&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c"># number of spatial dimensions</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s">&#39;cell_spatial&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c"># unitcell lengths</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s">&#39;cell_angular&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c"># unitcell angles</span>

        <span class="c"># Create variables.</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s">&#39;coordinates&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;frame&#39;</span><span class="p">,</span> <span class="s">&#39;atom&#39;</span><span class="p">,</span> <span class="s">&#39;spatial&#39;</span><span class="p">),</span>
                                       <span class="n">zlib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmplevel</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="s">&#39;units&#39;</span><span class="p">,</span> <span class="s">&#39;angstrom&#39;</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;frame&#39;</span><span class="p">,),</span>
                                     <span class="n">zlib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmplevel</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s">&#39;units&#39;</span><span class="p">,</span> <span class="s">&#39;picosecond&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="n">periodic</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">cell_lengths</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s">&#39;cell_lengths&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;frame&#39;</span><span class="p">,</span> <span class="s">&#39;cell_spatial&#39;</span><span class="p">),</span>
                                                 <span class="n">zlib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmplevel</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cell_lengths</span><span class="p">,</span> <span class="s">&#39;units&#39;</span><span class="p">,</span> <span class="s">&#39;angstrom&#39;</span><span class="p">)</span>
            <span class="n">cell_angles</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s">&#39;cell_angles&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;frame&#39;</span><span class="p">,</span> <span class="s">&#39;cell_angular&#39;</span><span class="p">),</span>
                                                <span class="n">zlib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmplevel</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cell_angles</span><span class="p">,</span> <span class="s">&#39;units&#39;</span><span class="p">,</span> <span class="s">&#39;degrees&#39;</span><span class="p">)</span>
        <span class="c"># These properties are optional, and are specified on Writer creation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">:</span>
            <span class="n">velocs</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s">&#39;velocities&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;frame&#39;</span><span class="p">,</span> <span class="s">&#39;atom&#39;</span><span class="p">,</span> <span class="s">&#39;spatial&#39;</span><span class="p">),</span>
                                           <span class="n">zlib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmplevel</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">velocs</span><span class="p">,</span> <span class="s">&#39;units&#39;</span><span class="p">,</span> <span class="s">&#39;angstrom/picosecond&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">:</span>
            <span class="n">forces</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s">&#39;forces&#39;</span><span class="p">,</span> <span class="s">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;frame&#39;</span><span class="p">,</span> <span class="s">&#39;atom&#39;</span><span class="p">,</span> <span class="s">&#39;spatial&#39;</span><span class="p">),</span>
                                           <span class="n">zlib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmplevel</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">forces</span><span class="p">,</span> <span class="s">&#39;units&#39;</span><span class="p">,</span> <span class="s">&#39;kilocalorie/mole/angstrom&#39;</span><span class="p">)</span>

        <span class="n">ncfile</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_frame</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="o">=</span> <span class="n">ncfile</span>

<div class="viewcode-block" id="NCDFWriter.is_periodic"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.NCDFWriter.is_periodic">[docs]</a>    <span class="k">def</span> <span class="nf">is_periodic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ``True`` if :class:`Timestep` *ts* contains a valid simulation box&quot;&quot;&quot;</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span> <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NCDFWriter.write_next_timestep"><a class="viewcode-back" href="../../../documentation_pages/coordinates/TRJ.html#MDAnalysis.coordinates.TRJ.NCDFWriter.write_next_timestep">[docs]</a>    <span class="k">def</span> <span class="nf">write_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;write a new timestep to the trj file</span>

<span class="sd">        *ts* is a :class:`Timestep` instance containing coordinates to</span>
<span class="sd">        be written to trajectory file</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;ts&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;NCDFWriter: no coordinate data to write to trajectory file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>  <span class="c"># self.ts would have to be assigned manually!</span>
        <span class="k">elif</span> <span class="n">ts</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;NCDFWriter: Timestep does not have the correct number of atoms&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># first time step: analyze data and open trajectory accordingly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_netcdf</span><span class="p">(</span><span class="n">periodic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_periodic</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_next_timestep</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_write_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write coordinates and unitcell information to NCDF file.</span>

<span class="sd">        Do not call this method directly; instead use</span>
<span class="sd">        :meth:`write_next_timestep` because some essential setup is done</span>
<span class="sd">        there before writing the first frame.</span>

<span class="sd">        Based on Joshua Adelman&#39;s `netcdf4storage.py`_ in `Issue 109`_.</span>

<span class="sd">        .. _`Issue 109`:</span>
<span class="sd">           https://github.com/MDAnalysis/mdanalysis/issues/109</span>
<span class="sd">        .. _`netcdf4storage.py`:</span>
<span class="sd">           https://storage.googleapis.com/google-code-attachments/mdanalysis/issue-109/comment-2/netcdf4storage.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;trjfile must be open in order to write to it&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
            <span class="c"># make a copy of the scaled positions so that the in-memory</span>
            <span class="c"># timestep is not changed (would have lead to wrong results if</span>
            <span class="c"># analysed *after* writing a time step to disk). The new</span>
            <span class="c"># implementation could lead to memory problems and/or slow-down for</span>
            <span class="c"># very big systems because we temporarily create a new array pos</span>
            <span class="c"># for each frame written</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_time_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_time_to_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">unitcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_dimensions_to_unitcell</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_pos</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">time</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
            <span class="n">unitcell</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="s">&#39;step&#39;</span><span class="p">):</span>
            <span class="c"># bogus, should be actual MD step number, i.e. frame * delta/dt</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">frame</span>

        <span class="c"># write step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_frame</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_frame</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;cell_lengths&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_frame</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">unitcell</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;cell_angles&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_frame</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">unitcell</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_velocities</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
                <span class="n">velocities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_velocities_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_velocities</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">velocities</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_velocities</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;velocities&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_frame</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">velocities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_forces</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_forces_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_forces</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_velocities</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;forces&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_frame</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">forces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_frame</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trjfile</span> <span class="o">=</span> <span class="bp">None</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">MDAnalysis 0.10.0-dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../MDAnalysis.html" >MDAnalysis</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2005-2015, Naveen Michaud-Agrawal, Elizabeth J. Denning, Joshua Adelman,
    Christian Beckstein (logo), Alejandro Bernardin, Sébastien Buchoux,
    David Caplan, Matthieu Chavent, Xavier Deupi, Jan Domański, David L. Dotson
    Lennard van der Feltz, Philip Fowler, Joseph Goose, Richard J. Gowers, Lukas Grossar,
    Benjamin Hall, Joe Jordan, Jinju Lu, Robert McGibbon, Alex Nesterenko,
    Manuel Nuno Melo, Caio S. Souza, Danny Parton, Joshua L. Phillips, Tyler Reddy,
    Paul Rigor, Sean L. Seyler, Andy Somogyi, Lukas Stelzl, Zhuyi Xue,
    and Oliver Beckstein.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>