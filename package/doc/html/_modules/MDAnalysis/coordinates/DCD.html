

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MDAnalysis.coordinates.DCD &mdash; MDAnalysis 0.10.0-dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.10.0-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within MDAnalysis 0.10.0-dev documentation"
          href="../../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../../_static/mdanalysis-logo.ico"/>
    <link rel="top" title="MDAnalysis 0.10.0-dev documentation" href="../../../index.html" />
    <link rel="up" title="MDAnalysis" href="../../MDAnalysis.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">MDAnalysis 0.10.0-dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../MDAnalysis.html" accesskey="U">MDAnalysis</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/mdanalysis-logo-200x150.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for MDAnalysis.coordinates.DCD</h1><div class="highlight"><pre>
<span class="c"># -*- Mode: python; tab-width: 4; indent-tabs-mode:nil; coding:utf-8 -*-</span>
<span class="c"># vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4 fileencoding=utf-8</span>
<span class="c">#</span>
<span class="c"># MDAnalysis --- http://www.MDAnalysis.org</span>
<span class="c"># Copyright (c) 2006-2015 Naveen Michaud-Agrawal, Elizabeth J. Denning, Oliver Beckstein</span>
<span class="c"># and contributors (see AUTHORS for the full list)</span>
<span class="c">#</span>
<span class="c"># Released under the GNU Public Licence, v2 or any higher version</span>
<span class="c">#</span>
<span class="c"># Please cite your use of MDAnalysis in published work:</span>
<span class="c">#</span>
<span class="c"># N. Michaud-Agrawal, E. J. Denning, T. B. Woolf, and O. Beckstein.</span>
<span class="c"># MDAnalysis: A Toolkit for the Analysis of Molecular Dynamics Simulations.</span>
<span class="c"># J. Comput. Chem. 32 (2011), 2319--2327, doi:10.1002/jcc.21787</span>
<span class="c">#</span>


<span class="sd">&quot;&quot;&quot;DCD trajectory I/O  --- :mod:`MDAnalysis.coordinates.DCD`</span>
<span class="sd">============================================================</span>

<span class="sd">Classes to read and write DCD binary trajectories, the format used by</span>
<span class="sd">CHARMM, NAMD but also LAMMPS. Trajectories can be read regardless of</span>
<span class="sd">system-endianness as this is auto-detected.</span>

<span class="sd">Generally, DCD trajectories produced by any code can be read (with the</span>
<span class="sd">:class:`DCDReader`) although there can be issues with the unitcell</span>
<span class="sd">(simulation box) representation (see</span>
<span class="sd">:attr:`Timestep.dimensions`). DCDs can also be written but the</span>
<span class="sd">:class:`DCDWriter` follows recent NAMD/VMD convention for the unitcell</span>
<span class="sd">but still writes AKMA time. Reading and writing these trajectories</span>
<span class="sd">within MDAnalysis will work seamlessly but if you process those</span>
<span class="sd">trajectories with other tools you might need to watch out that time</span>
<span class="sd">and unitcell dimensions are correctly interpreted.</span>

<span class="sd">.. Note:: </span>

<span class="sd">   The DCD file format is not well defined. In particular, NAMD and</span>
<span class="sd">   CHARMM use it differently. Currently, MDAnalysis tries to guess the</span>
<span class="sd">   correct **format for the unitcell representation** but it can be</span>
<span class="sd">   wrong. **Check the unitcell dimensions**, especially for triclinic</span>
<span class="sd">   unitcells (see `Issue 187`_ and :attr:`Timestep.dimensions`). A</span>
<span class="sd">   second potential issue are the units of time which are AKMA for the</span>
<span class="sd">   :class:`DCDReader` (following CHARMM) but ps for NAMD. As a</span>
<span class="sd">   workaround one can employ the configurable</span>
<span class="sd">   :class:`MDAnalysis.coordinates.LAMMPS.DCDReader` for NAMD</span>
<span class="sd">   trajectories.</span>

<span class="sd">.. SeeAlso:: The :mod:`MDAnalysis.coordinates.LAMMPS` module provides</span>
<span class="sd">             a more flexible DCD reader/writer.</span>

<span class="sd">The classes in this module are the reference implementations for the</span>
<span class="sd">Trajectory API.</span>

<span class="sd">.. _Issue 187:</span>
<span class="sd">   https://github.com/MDAnalysis/mdanalysis/issues/187</span>


<span class="sd">Classes</span>
<span class="sd">-------</span>

<span class="sd">.. autoclass:: Timestep</span>
<span class="sd">   :inherited-members:</span>
<span class="sd">.. autoclass:: DCDReader</span>
<span class="sd">   :inherited-members:</span>
<span class="sd">.. autoclass:: DCDWriter</span>
<span class="sd">   :inherited-members:</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">import</span> <span class="nn">MDAnalysis.core</span>
<span class="kn">import</span> <span class="nn">MDAnalysis.core.units</span>
<span class="kn">from</span> <span class="nn">MDAnalysis</span> <span class="kn">import</span> <span class="n">NoDataError</span>


<div class="viewcode-block" id="Timestep"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.Timestep">[docs]</a><span class="k">class</span> <span class="nc">Timestep</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Timestep</span><span class="p">):</span>
    <span class="c">#: Indices into :attr:`Timestep._unitcell` (``[A, gamma, B, beta, alpha,</span>
    <span class="c">#: C]``, provided by the :class:`DCDReader` C code) to pull out</span>
    <span class="c">#: ``[A, B, C, alpha, beta, gamma]``.</span>
    <span class="n">_ts_order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c">#: indices into :attr:`Timestep._unitcell`` to pull out</span>
    <span class="c">#: ``[A, B, C, alpha, beta, gamma]``.</span>
    <span class="c">### old (MDAnalysis 0.8.1)</span>
    <span class="c">###_ts_order = [0, 2, 5, 4, 3, 1]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;unitcell dimensions (*A*, *B*, *C*, *alpha*, *beta*, *gamma*)</span>

<span class="sd">        lengths *A*, *B*, *C* are in the MDAnalysis length unit (Ã…), and</span>
<span class="sd">        angles are in degrees.</span>

<span class="sd">        :attr:`dimensions` is read-only because it transforms the actual format</span>
<span class="sd">        of the unitcell (which differs between different trajectory formats) to</span>
<span class="sd">        the representation described here, which is used everywhere in</span>
<span class="sd">        MDAnalysis.</span>

<span class="sd">        The ordering of the angles in the unitcell is the same as in recent</span>
<span class="sd">        versions of VMD&#39;s DCDplugin_ (2013), namely the `X-PLOR DCD format`_:</span>
<span class="sd">        The original unitcell is read as ``[A, gamma, B, beta, alpha, C]`` from</span>
<span class="sd">        the DCD file (actually, the direction cosines are stored instead of the</span>
<span class="sd">        angles but the underlying C code already does this conversion); if any</span>
<span class="sd">        of these values are &lt; 0 or if any of the angles are &gt; 180 degrees then</span>
<span class="sd">        it is assumed it is a new-style CHARMM unitcell (at least since c36b2)</span>
<span class="sd">        in which box vectors were recorded.</span>

<span class="sd">        .. warning:: The DCD format is not well defined. Check your unit cell</span>
<span class="sd">           dimensions carefully, especially when using triclinic</span>
<span class="sd">           boxes. Different software packages implement different conventions</span>
<span class="sd">           and MDAnalysis is currently implementing the newer NAMD/VMD convention</span>
<span class="sd">           and tries to guess the new CHARMM one. Old CHARMM trajectories might</span>
<span class="sd">           give wrong unitcell values. For more details see `Issue 187`_.</span>

<span class="sd">        .. versionchanged:: 0.9.0</span>
<span class="sd">           Unitcell is now interpreted in the newer NAMD DCD format as ``[A,</span>
<span class="sd">           gamma, B, beta, alpha, C]`` instead of the old MDAnalysis/CHARMM</span>
<span class="sd">           ordering ``[A, alpha, B, beta, gamma, C]``. We attempt to detect the</span>
<span class="sd">           new CHARMM DCD unitcell format (see `Issue 187`_ for a discussion).</span>

<span class="sd">        .. _`X-PLOR DCD format`: http://www.ks.uiuc.edu/Research/vmd/plugins/molfile/dcdplugin.html</span>
<span class="sd">        .. _Issue 187: https://github.com/MDAnalysis/mdanalysis/issues/187</span>
<span class="sd">        .. _DCDplugin: http://www.ks.uiuc.edu/Research/vmd/plugins/doxygen/dcdplugin_8c-source.html#l00947</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Layout of unitcell is [A, alpha, B, beta, gamma, C] --- (originally CHARMM DCD)</span>
        <span class="c"># override for other formats; this strange ordering is kept for historical reasons</span>
        <span class="c"># (the user should not need concern themselves with this)</span>
        <span class="c">## orig MDAnalysis 0.8.1/dcd.c (~2004)</span>
        <span class="c">##return numpy.take(self._unitcell, [0,2,5,1,3,4])</span>

        <span class="c"># MDAnalysis 0.9.0 with recent dcd.c (based on 2013 molfile</span>
        <span class="c"># DCD plugin, which implements the ordering of recent NAMD</span>
        <span class="c"># (&gt;2.5?)). See Issue 187.</span>
        <span class="n">uc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts_order</span><span class="p">)</span>
        <span class="c"># heuristic sanity check: uc = A,B,C,alpha,beta,gamma</span>
        <span class="c"># XXX: should we worry about these comparisons with floats?</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">uc</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">uc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="mf">180.</span><span class="p">):</span>
            <span class="c"># might be new CHARMM: box matrix vectors</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e3</span> <span class="o">=</span> <span class="n">H</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span>  <span class="n">H</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]],</span> <span class="n">H</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]]</span>
            <span class="n">uc</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">triclinic_box</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uc</span>

    <span class="nd">@dimensions.setter</span>
<div class="viewcode-block" id="Timestep.dimensions"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.Timestep.dimensions">[docs]</a>    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set unitcell with (*A*, *B*, *C*, *alpha*, *beta*, *gamma*)</span>

<span class="sd">        .. versionadded:: 0.9.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># note that we can re-use self._ts_order with put!</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts_order</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="DCDWriter"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.DCDWriter">[docs]</a><span class="k">class</span> <span class="nc">DCDWriter</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Writer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes to a DCD file</span>

<span class="sd">    Typical usage::</span>

<span class="sd">       with DCDWriter(&quot;new.dcd&quot;, u.atoms.numberOfAtoms()) as w:</span>
<span class="sd">           for ts in u.trajectory</span>
<span class="sd">               w.write_next_timestep(ts)</span>

<span class="sd">    Keywords are available to set some of the low-level attributes of the DCD.</span>

<span class="sd">    :Methods:</span>
<span class="sd">       ``d = DCDWriter(dcdfilename, numatoms, start, step, delta, remarks)``</span>

<span class="sd">    .. Note::</span>

<span class="sd">       The Writer will write the **unit cell information** to the DCD in a</span>
<span class="sd">       format compatible with NAMD and older CHARMM versions, namely the unit</span>
<span class="sd">       cell lengths in Angstrom and the angle cosines (see</span>
<span class="sd">       :class:`Timestep`). Newer versions of CHARMM (at least c36b2) store the</span>
<span class="sd">       matrix of the box vectors. Writing this matrix to a DCD is currently not</span>
<span class="sd">       supported (although reading is supported with the</span>
<span class="sd">       :class:`DCDReader`); instead the angle cosines are written,</span>
<span class="sd">       which *might make the DCD file unusable in CHARMM itself*. See</span>
<span class="sd">       `Issue 187`_ for further information.</span>

<span class="sd">       The writing behavior of the :class:`DCDWriter` is identical to</span>
<span class="sd">       that of the DCD molfile plugin of VMD with the exception that</span>
<span class="sd">       by default it will use AKMA time units.</span>

<span class="sd">    .. _Issue 187: https://github.com/MDAnalysis/mdanalysis/issues/187</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;DCD&#39;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;AKMA&#39;</span><span class="p">,</span> <span class="s">&#39;length&#39;</span><span class="p">:</span> <span class="s">&#39;Angstrom&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">numatoms</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">delta</span><span class="o">=</span><span class="n">MDAnalysis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="s">&#39;ps&#39;</span><span class="p">,</span> <span class="s">&#39;AKMA&#39;</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">remarks</span><span class="o">=</span><span class="s">&quot;Created by DCDWriter&quot;</span><span class="p">,</span> <span class="n">convert_units</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new DCDWriter</span>

<span class="sd">        :Arguments:</span>
<span class="sd">         *filename*</span>
<span class="sd">           name of output file</span>
<span class="sd">         *numatoms*</span>
<span class="sd">           number of atoms in dcd file</span>
<span class="sd">         *start*</span>
<span class="sd">           starting timestep</span>
<span class="sd">         *step*</span>
<span class="sd">           skip between subsequent timesteps (indicate that *step* MD</span>
<span class="sd">           integrator steps (!) make up one trajectory frame); default is 1.</span>
<span class="sd">         *delta*</span>
<span class="sd">           timestep (MD integrator time step (!), in AKMA units); default is</span>
<span class="sd">           20.45482949774598 (corresponding to 1 ps).</span>
<span class="sd">         *remarks*</span>
<span class="sd">           comments to annotate dcd file</span>
<span class="sd">         *dt*</span>
<span class="sd">           **Override** *step* and *delta* so that the DCD records that *dt* ps</span>
<span class="sd">           lie between two frames. (It sets *step* = 1 and *delta* = ``AKMA(dt)``.)</span>
<span class="sd">           The default is ``None``, in which case *step* and *delta* are used.</span>
<span class="sd">         *convert_units*</span>
<span class="sd">           units are converted to the MDAnalysis base format; ``None`` selects</span>
<span class="sd">           the value of :data:`MDAnalysis.core.flags` [&#39;convert_lengths&#39;].</span>
<span class="sd">           (see :ref:`flags-label`)</span>

<span class="sd">       .. Note::</span>

<span class="sd">          The keyword arguments set the low-level attributes of the DCD</span>
<span class="sd">          according to the CHARMM format. The time between two frames would be</span>
<span class="sd">          *delta* * *step* ! For convenience, one can alternatively supply the</span>
<span class="sd">          *dt* keyword (see above) to just tell the writer that it should</span>
<span class="sd">          record &quot;There are dt ps between each frame&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">numatoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;DCDWriter: no atoms in output trajectory&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">numatoms</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># probably called from MDAnalysis.Writer() so need to give user a gentle heads up...</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;DCDWriter: REQUIRES the number of atoms in the &#39;numatoms&#39; argument</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
                             <span class="s">&quot; &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="s">&quot;ValueError: &quot;</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s">&quot;For example: numatoms=universe.atoms.numberOfAtoms()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c"># convert length and time to base units on the fly?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s">&#39;convert_lengths&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">convert_units</span> <span class="ow">is</span> <span class="bp">None</span> \
            <span class="k">else</span> <span class="n">convert_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">=</span> <span class="n">numatoms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frames_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># ignore step and delta</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">MDAnalysis</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s">&#39;ps&#39;</span><span class="p">,</span> <span class="s">&#39;AKMA&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;DCDWriter: dt must be &gt; 0, not {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remarks</span> <span class="o">=</span> <span class="n">remarks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_dcd_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remarks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dcd_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns contents of the DCD header C structure::</span>
<span class="sd">             typedef struct {</span>
<span class="sd">               fio_fd fd;                 // FILE *</span>
<span class="sd">               fio_size_t header_size;    // size_t == sizeof(int)</span>
<span class="sd">               int natoms;</span>
<span class="sd">               int nsets;</span>
<span class="sd">               int setsread;</span>
<span class="sd">               int istart;</span>
<span class="sd">               int nsavc;</span>
<span class="sd">               double delta;</span>
<span class="sd">               int nfixed;</span>
<span class="sd">               int *freeind;</span>
<span class="sd">               float *fixedcoords;</span>
<span class="sd">               int reverse;</span>
<span class="sd">               int charmm;</span>
<span class="sd">               int first;</span>
<span class="sd">               int with_unitcell;</span>
<span class="sd">             } dcdhandle;</span>

<span class="sd">        .. deprecated:: 0.7.5</span>
<span class="sd">           This function only exists for debugging purposes and might</span>
<span class="sd">           be removed without notice. Do not rely on it.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># was broken (no idea why [orbeckst]), see Issue 27</span>
        <span class="c"># &#39;PiiiiiidiPPiiii&#39; should be the unpack string according to the struct.</span>
        <span class="c">#    struct.unpack(&quot;LLiiiiidiPPiiii&quot;,self._dcd_C_str)</span>
        <span class="c"># seems to do the job on Mac OS X 10.6.4 ... but I have no idea why,</span>
        <span class="c"># given that the C code seems to define them as normal integers</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;file_desc&#39;</span><span class="p">,</span> <span class="s">&#39;header_size&#39;</span><span class="p">,</span> <span class="s">&#39;natoms&#39;</span><span class="p">,</span> <span class="s">&#39;nsets&#39;</span><span class="p">,</span> <span class="s">&#39;setsread&#39;</span><span class="p">,</span> <span class="s">&#39;istart&#39;</span><span class="p">,</span>
            <span class="s">&#39;nsavc&#39;</span><span class="p">,</span> <span class="s">&#39;delta&#39;</span><span class="p">,</span> <span class="s">&#39;nfixed&#39;</span><span class="p">,</span> <span class="s">&#39;freeind_ptr&#39;</span><span class="p">,</span> <span class="s">&#39;fixedcoords_ptr&#39;</span><span class="p">,</span>
            <span class="s">&#39;reverse&#39;</span><span class="p">,</span> <span class="s">&#39;charmm&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;with_unitcell&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;LLiiiiidiPPiiii&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcd_C_str</span><span class="p">)))</span>

<div class="viewcode-block" id="DCDWriter.write_next_timestep"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.DCDWriter.write_next_timestep">[docs]</a>    <span class="k">def</span> <span class="nf">write_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; write a new timestep to the dcd file</span>

<span class="sd">        *ts* - timestep object containing coordinates to be written to dcd file</span>

<span class="sd">        .. versionchanged:: 0.7.5</span>
<span class="sd">           Raises :exc:`ValueError` instead of generic :exc:`Exception`</span>
<span class="sd">           if wrong number of atoms supplied and :exc:`~MDAnalysis.NoDataError`</span>
<span class="sd">           if no coordinates to be written.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;ts&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">NoDataError</span><span class="p">(</span><span class="s">&quot;DCDWriter: no coordinate data to write to trajectory file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">ts</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;DCDWriter: Timestep does not have the correct number of atoms&quot;</span><span class="p">)</span>
        <span class="n">unitcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_dimensions_to_unitcell</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c"># must be float32 (!)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ts</span><span class="o">.</span><span class="n">_pos</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">f_contiguous</span><span class="p">:</span>  <span class="c"># Not in fortran format</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">Timestep</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>  <span class="c"># wrap in a new fortran formatted Timestep</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_to_native</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_pos</span><span class="p">,</span>
                                             <span class="n">inplace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c"># possibly make a copy to avoid changing the trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_next_frame</span><span class="p">(</span><span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">unitcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames_written</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c">#     def convert_dimensions_to_unitcell(self, ts, _ts_order=Timestep._ts_order):</span>
<span class="c">#         &quot;&quot;&quot;Read dimensions from timestep *ts* and return appropriate unitcell.</span>

<span class="c">#         .. SeeAlso:: :class:`Timestep`</span>
<span class="c">#         &quot;&quot;&quot;</span>
<span class="c">#         unitcell = super(DCDWriter, self).convert_dimensions_to_unitcell(ts)</span>
<span class="c">#         # unitcell is A,B,C,alpha,beta,gamma - convert to order expected by low level</span>
<span class="c">#         # DCD routines</span>
</div>
<div class="viewcode-block" id="DCDWriter.convert_dimensions_to_unitcell"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.DCDWriter.convert_dimensions_to_unitcell">[docs]</a>    <span class="k">def</span> <span class="nf">convert_dimensions_to_unitcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">_ts_order</span><span class="o">=</span><span class="n">Timestep</span><span class="o">.</span><span class="n">_ts_order</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read dimensions from timestep *ts* and return appropriate native unitcell.</span>

<span class="sd">        .. SeeAlso:: :attr:`Timestep.dimensions`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># unitcell is A,B,C,alpha,beta,gamma - convert to order expected by low level DCD routines</span>
        <span class="n">lengths</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_pos_to_native</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
        <span class="n">unitcell</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="c"># __write_DCD_frame() wants uc_array = [A, gamma, B, beta, alpha, C] and</span>
        <span class="c"># will write the lengths and the angle cosines to the DCD. NOTE: It</span>
        <span class="c"># will NOT write CHARMM36+ box matrix vectors. When round-tripping a</span>
        <span class="c"># C36+ DCD, we loose the box vector information. However, MDAnalysis</span>
        <span class="c"># itself will not detect this because the DCDReader contains the</span>
        <span class="c"># heuristic to deal with either lengths/angles or box matrix on the fly.</span>
        <span class="c">#</span>
        <span class="c"># use numpy.put so that we can re-use ts_order (otherwise we</span>
        <span class="c"># would need a ts_reverse_order such as _ts_reverse_order = [0, 5, 1, 4, 3, 2])</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">unitcell</span><span class="p">,</span> <span class="n">_ts_order</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">lengths</span><span class="p">,</span> <span class="n">angles</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">unitcell</span>
</div>
<div class="viewcode-block" id="DCDWriter.close"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.DCDWriter.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close trajectory and flush buffers.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;dcdfile&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finish_dcd_write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span> <span class="o">=</span> <span class="bp">None</span>

</div></div>
<div class="viewcode-block" id="DCDReader"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.DCDReader">[docs]</a><span class="k">class</span> <span class="nc">DCDReader</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads from a DCD file</span>

<span class="sd">    :Data:</span>
<span class="sd">        ts</span>
<span class="sd">          :class:`Timestep` object containing coordinates of current frame</span>

<span class="sd">    :Methods:</span>
<span class="sd">        ``dcd = DCD(dcdfilename)``</span>
<span class="sd">           open dcd file and read header</span>
<span class="sd">        ``len(dcd)``</span>
<span class="sd">           return number of frames in dcd</span>
<span class="sd">        ``for ts in dcd:``</span>
<span class="sd">           iterate through trajectory</span>
<span class="sd">        ``for ts in dcd[start:stop:skip]:``</span>
<span class="sd">           iterate through a trajectory</span>
<span class="sd">        ``dcd[i]``</span>
<span class="sd">           random access into the trajectory (i corresponds to frame number)</span>
<span class="sd">        ``data = dcd.timeseries(...)``</span>
<span class="sd">           retrieve a subset of coordinate information for a group of atoms</span>
<span class="sd">        ``data = dcd.correl(...)``</span>
<span class="sd">           populate a :class:`MDAnalysis.core.Timeseries.Collection` object with computed timeseries</span>

<span class="sd">    .. Note:: </span>

<span class="sd">       The DCD file format is not well defined. In particular, NAMD</span>
<span class="sd">       and CHARMM use it differently. Currently, MDAnalysis tries to</span>
<span class="sd">       guess the correct format for the unitcell representation but it</span>
<span class="sd">       can be wrong. **Check the unitcell dimensions**, especially for</span>
<span class="sd">       triclinic unitcells (see `Issue 187`_ and</span>
<span class="sd">       :attr:`Timestep.dimensions`). A second potential issue are the</span>
<span class="sd">       units of time (TODO).</span>

<span class="sd">    .. versionchanged:: 0.9.0</span>
<span class="sd">       The underlying DCD reader (written in C and derived from the</span>
<span class="sd">       catdcd/molfile plugin code of VMD) is now reading the unitcell in</span>
<span class="sd">       NAMD ordering: ``[A, B, C, sin(gamma), sin(beta),</span>
<span class="sd">       sin(alpha)]``. See `Issue 187`_ for further details.</span>

<span class="sd">    .. _Issue 187: https://github.com/MDAnalysis/mdanalysis/issues/187</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;DCD&#39;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;AKMA&#39;</span><span class="p">,</span> <span class="s">&#39;length&#39;</span><span class="p">:</span> <span class="s">&#39;Angstrom&#39;</span><span class="p">}</span>
    <span class="n">_Timestep</span> <span class="o">=</span> <span class="n">Timestep</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dcdfilename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcdfilename</span> <span class="o">=</span> <span class="n">dcdfilename</span>  <span class="c"># dcdfilename is legacy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># set right away because __del__ checks</span>

        <span class="c"># Issue #32: segfault if dcd is 0-size</span>
        <span class="c"># Hack : test here... (but should be fixed in dcd.c)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&quot;DCD file is zero size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numframes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_read_dcd_header</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Timestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">)</span>
        <span class="c"># Read in the first timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_dcd_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns contents of the DCD header C structure::</span>
<span class="sd">             typedef struct {</span>
<span class="sd">               fio_fd fd;                 // FILE *</span>
<span class="sd">               fio_size_t header_size;    // size_t == sizeof(int)</span>
<span class="sd">               int natoms;</span>
<span class="sd">               int nsets;</span>
<span class="sd">               int setsread;</span>
<span class="sd">               int istart;</span>
<span class="sd">               int nsavc;</span>
<span class="sd">               double delta;</span>
<span class="sd">               int nfixed;</span>
<span class="sd">               int *freeind;</span>
<span class="sd">               float *fixedcoords;</span>
<span class="sd">               int reverse;</span>
<span class="sd">               int charmm;</span>
<span class="sd">               int first;</span>
<span class="sd">               int with_unitcell;</span>
<span class="sd">             } dcdhandle;</span>

<span class="sd">        .. deprecated:: 0.7.5</span>
<span class="sd">           This function only exists for debugging purposes and might</span>
<span class="sd">           be removed without notice. Do not rely on it.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># was broken (no idea why [orbeckst]), see Issue 27</span>
        <span class="c"># &#39;PiiiiiidiPPiiii&#39; should be the unpack string according to the struct.</span>
        <span class="c">#    struct.unpack(&quot;LLiiiiidiPPiiii&quot;,self._dcd_C_str)</span>
        <span class="c"># seems to do the job on Mac OS X 10.6.4 ... but I have no idea why,</span>
        <span class="c"># given that the C code seems to define them as normal integers</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;file_desc&#39;</span><span class="p">,</span> <span class="s">&#39;header_size&#39;</span><span class="p">,</span> <span class="s">&#39;natoms&#39;</span><span class="p">,</span> <span class="s">&#39;nsets&#39;</span><span class="p">,</span> <span class="s">&#39;setsread&#39;</span><span class="p">,</span> <span class="s">&#39;istart&#39;</span><span class="p">,</span>
            <span class="s">&#39;nsavc&#39;</span><span class="p">,</span> <span class="s">&#39;delta&#39;</span><span class="p">,</span> <span class="s">&#39;nfixed&#39;</span><span class="p">,</span> <span class="s">&#39;freeind_ptr&#39;</span><span class="p">,</span> <span class="s">&#39;fixedcoords_ptr&#39;</span><span class="p">,</span> <span class="s">&#39;reverse&#39;</span><span class="p">,</span>
            <span class="s">&#39;charmm&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;with_unitcell&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;LLiiiiidiPPiiii&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcd_C_str</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Reset the trajectory file, read from the start</span>
        <span class="c"># usage is &quot;from ts in dcd:&quot; where dcd does not have indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_dcd_read</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">iterDCD</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numframes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">):</span>  <span class="c"># FIXME: skip is not working!!!</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_timestep</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="k">return</span> <span class="n">iterDCD</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_next_timestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_frame</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">def</span> <span class="nf">_read_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jump_to_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_next_frame</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">_z</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">_unitcell</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># XXX required!!</span>
        <span class="k">return</span> <span class="n">ts</span>

<div class="viewcode-block" id="DCDReader.timeseries"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.DCDReader.timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asel</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;afc&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a subset of coordinate data for an AtomGroup</span>

<span class="sd">        :Arguments:</span>
<span class="sd">            *asel*</span>
<span class="sd">               :class:`~MDAnalysis.core.AtomGroup.AtomGroup` object</span>
<span class="sd">            *start, stop, skip*</span>
<span class="sd">               range of trajectory to access, start and stop are inclusive</span>
<span class="sd">            *format*</span>
<span class="sd">               the order/shape of the return data array, corresponding</span>
<span class="sd">               to (a)tom, (f)rame, (c)oordinates all six combinations</span>
<span class="sd">               of &#39;a&#39;, &#39;f&#39;, &#39;c&#39; are allowed ie &quot;fac&quot; - return array</span>
<span class="sd">               where the shape is (frame, number of atoms,</span>
<span class="sd">               coordinates)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_slice_indices</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">asel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoDataError</span><span class="p">(</span><span class="s">&quot;Timeseries requires at least one atom to analyze&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;afc&#39;</span><span class="p">,</span> <span class="s">&#39;acf&#39;</span><span class="p">,</span> <span class="s">&#39;caf&#39;</span><span class="p">,</span> <span class="s">&#39;cfa&#39;</span><span class="p">,</span> <span class="s">&#39;fac&#39;</span><span class="p">,</span> <span class="s">&#39;fca&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid timeseries format&quot;</span><span class="p">)</span>
        <span class="n">atom_numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">asel</span><span class="o">.</span><span class="n">indices</span><span class="p">())</span>
        <span class="c"># Check if the atom numbers can be grouped for efficiency, then we can read partial buffers</span>
        <span class="c"># from trajectory file instead of an entire timestep</span>
        <span class="c"># XXX needs to be implemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_timeseries</span><span class="p">(</span><span class="n">atom_numbers</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">format</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DCDReader.correl"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.DCDReader.correl">[docs]</a>    <span class="k">def</span> <span class="nf">correl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate a TimeseriesCollection object with timeseries computed from the trajectory</span>

<span class="sd">        :Arguments:</span>
<span class="sd">            *timeseries*</span>
<span class="sd">               :class:`MDAnalysis.core.Timeseries.TimeseriesCollection`</span>
<span class="sd">            *start, stop, skip*</span>
<span class="sd">               subset of trajectory to use, with start and stop being inclusive</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_slice_indices</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
        <span class="n">atomlist</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">_getAtomList</span><span class="p">()</span>
        <span class="n">format</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">_getFormat</span><span class="p">()</span>
        <span class="n">lowerb</span><span class="p">,</span> <span class="n">upperb</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">_getBounds</span><span class="p">()</span>
        <span class="n">sizedata</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">_getDataSize</span><span class="p">()</span>
        <span class="n">atomcounts</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">_getAtomCounts</span><span class="p">()</span>
        <span class="n">auxdata</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">_getAuxData</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_timecorrel</span><span class="p">(</span><span class="n">atomlist</span><span class="p">,</span> <span class="n">atomcounts</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">auxdata</span><span class="p">,</span>
                                     <span class="n">sizedata</span><span class="p">,</span> <span class="n">lowerb</span><span class="p">,</span> <span class="n">upperb</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finish_dcd_read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcdfile</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="DCDReader.Writer"><a class="viewcode-back" href="../../../documentation_pages/coordinates/DCD.html#MDAnalysis.coordinates.DCD.DCDReader.Writer">[docs]</a>    <span class="k">def</span> <span class="nf">Writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a DCDWriter for *filename* with the same parameters as this DCD.</span>

<span class="sd">        All values can be changed through keyword arguments.</span>

<span class="sd">        :Arguments:</span>
<span class="sd">          *filename*</span>
<span class="sd">              filename of the output DCD trajectory</span>
<span class="sd">        :Keywords:</span>
<span class="sd">          *numatoms*</span>
<span class="sd">              number of atoms</span>
<span class="sd">          *start*</span>
<span class="sd">              number of the first recorded MD step</span>
<span class="sd">          *step*</span>
<span class="sd">              indicate that *step* MD steps (!) make up one trajectory frame</span>
<span class="sd">          *delta*</span>
<span class="sd">              MD integrator time step (!), in AKMA units</span>
<span class="sd">          *dt*</span>
<span class="sd">             **Override** *step* and *delta* so that the DCD records that *dt* ps</span>
<span class="sd">             lie between two frames. (It sets *step* = 1 and *delta* = ``AKMA(dt)``.)</span>
<span class="sd">             The default is ``None``, in which case *step* and *delta* are used.</span>
<span class="sd">          *remarks*</span>
<span class="sd">              string that is stored in the DCD header [XXX -- max length?]</span>

<span class="sd">        :Returns: :class:`DCDWriter`</span>

<span class="sd">        .. Note::</span>

<span class="sd">           The keyword arguments set the low-level attributes of the DCD</span>
<span class="sd">           according to the CHARMM format. The time between two frames would be</span>
<span class="sd">           *delta* * *step* !</span>

<span class="sd">        .. SeeAlso:: :class:`DCDWriter` has detailed argument description</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">numatoms</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;numatoms&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numatoms</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;start&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_timestep</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;step&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_timestep</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;delta&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;remarks&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remarks</span><span class="p">)</span>
        <span class="c"># dt keyword is simply passed through if provided</span>
        <span class="k">return</span> <span class="n">DCDWriter</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">numatoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c"># Add the c functions to their respective classes so they act as class methods</span></div></div>
<span class="kn">import</span> <span class="nn">_dcdmodule</span>
<span class="kn">import</span> <span class="nn">new</span>

<span class="n">DCDReader</span><span class="o">.</span><span class="n">_read_dcd_header</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__read_dcd_header</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDReader</span><span class="p">)</span>
<span class="n">DCDReader</span><span class="o">.</span><span class="n">_read_next_frame</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__read_next_frame</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDReader</span><span class="p">)</span>
<span class="n">DCDReader</span><span class="o">.</span><span class="n">_jump_to_frame</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__jump_to_frame</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDReader</span><span class="p">)</span>
<span class="n">DCDReader</span><span class="o">.</span><span class="n">_reset_dcd_read</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__reset_dcd_read</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDReader</span><span class="p">)</span>
<span class="n">DCDReader</span><span class="o">.</span><span class="n">_finish_dcd_read</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__finish_dcd_read</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDReader</span><span class="p">)</span>
<span class="n">DCDReader</span><span class="o">.</span><span class="n">_read_timeseries</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__read_timeseries</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDReader</span><span class="p">)</span>

<span class="n">DCDWriter</span><span class="o">.</span><span class="n">_write_dcd_header</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__write_dcd_header</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDWriter</span><span class="p">)</span>
<span class="n">DCDWriter</span><span class="o">.</span><span class="n">_write_next_frame</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__write_next_frame</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDWriter</span><span class="p">)</span>
<span class="n">DCDWriter</span><span class="o">.</span><span class="n">_finish_dcd_write</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">_dcdmodule</span><span class="o">.</span><span class="n">__finish_dcd_write</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDWriter</span><span class="p">)</span>
<span class="k">del</span> <span class="p">(</span><span class="n">_dcdmodule</span><span class="p">)</span>

<span class="c"># dcdtimeseries is implemented with Pyrex - hopefully all dcd reading functionality can move to pyrex</span>
<span class="kn">import</span> <span class="nn">dcdtimeseries</span>
<span class="c">#DCDReader._read_timeseries = new.instancemethod(dcdtimeseries.__read_timeseries, None, DCDReader)</span>
<span class="n">DCDReader</span><span class="o">.</span><span class="n">_read_timecorrel</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">instancemethod</span><span class="p">(</span><span class="n">dcdtimeseries</span><span class="o">.</span><span class="n">__read_timecorrel</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">DCDReader</span><span class="p">)</span>
<span class="k">del</span> <span class="p">(</span><span class="n">dcdtimeseries</span><span class="p">)</span>
<span class="k">del</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">MDAnalysis 0.10.0-dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../MDAnalysis.html" >MDAnalysis</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2005-2015, Naveen Michaud-Agrawal, Elizabeth J. Denning, Joshua Adelman,
    Christian Beckstein (logo), Alejandro Bernardin, SÃ©bastien Buchoux,
    David Caplan, Matthieu Chavent, Xavier Deupi, Jan DomaÅ„ski, David L. Dotson
    Lennard van der Feltz, Philip Fowler, Joseph Goose, Richard J. Gowers, Lukas Grossar,
    Benjamin Hall, Joe Jordan, Jinju Lu, Robert McGibbon, Alex Nesterenko,
    Manuel Nuno Melo, Caio S. Souza, Danny Parton, Joshua L. Phillips, Tyler Reddy,
    Paul Rigor, Sean L. Seyler, Andy Somogyi, Lukas Stelzl, Zhuyi Xue,
    and Oliver Beckstein.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>